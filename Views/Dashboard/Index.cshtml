@{
    ViewData["Title"] = "Dashboard Financeiro";
}

<h2>Dashboard Financeiro</h2>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-success text-white">Distribuição por Categoria</div>
            <div class="card-body text-center">
                <canvas id="graficoPizza" style="max-width:350px; max-height:250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">Receitas vs Despesas por Mês</div>
            <div class="card-body text-center">
                <canvas id="graficoBarras" style="max-width:350px; max-height:250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-info text-white">Saldo Acumulado</div>
            <div class="card-body text-center">
                <canvas id="graficoLinhas" style="max-width:350px; max-height:250px;"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">Evolução Receitas vs Despesas</div>
            <div class="card-body text-center">
                <canvas id="graficoArea" style="max-width:350px; max-height:250px;"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function carregarFinanceiro() {
            const resp = await fetch('/Financeiro/Listar');
            const registros = await resp.json();

            if (!registros || registros.length === 0) {
                alert("Nenhum dado financeiro encontrado.");
                return;
            }

            // --- Pizza: categorias ---
            const categorias = {};
            registros.forEach(r => {
                categorias[r.categoria || 'Sem categoria'] = (categorias[r.categoria || 'Sem categoria'] || 0) + Number(r.valor || 0);
            });

            new Chart(document.getElementById('graficoPizza'), {
                type: 'pie',
                data: {
                    labels: Object.keys(categorias),
                    datasets: [{
                        data: Object.values(categorias),
                        backgroundColor: ['#28a745','#dc3545','#6c757d','#ffc107','#17a2b8']
                    }]
                }
            });

            // --- Barras: receitas vs despesas ---
            const meses = {};
            registros.forEach(r => {
                const d = new Date(r.data);
                if (isNaN(d)) return;
                const mes = d.toLocaleString('default', { month: 'short', year: 'numeric' });
                if (!meses[mes]) meses[mes] = { receita: 0, despesa: 0 };
                if ((r.tipo || '').toLowerCase() === 'receita') meses[mes].receita += Number(r.valor || 0);
                else meses[mes].despesa += Number(r.valor || 0);
            });

            new Chart(document.getElementById('graficoBarras'), {
                type: 'bar',
                data: {
                    labels: Object.keys(meses),
                    datasets: [
                        { label: 'Receitas', data: Object.values(meses).map(m => m.receita), backgroundColor: '#28a745' },
                        { label: 'Despesas', data: Object.values(meses).map(m => m.despesa), backgroundColor: '#dc3545' }
                    ]
                }
            });

            // --- Linhas: saldo acumulado ---
            const ordenados = [...registros].filter(r => !isNaN(new Date(r.data))).sort((a,b) => new Date(a.data) - new Date(b.data));
            let saldo = 0;
            const labels = [];
            const valores = [];
            ordenados.forEach(r => {
                const v = Number(r.valor || 0);
                saldo += ((r.tipo || '').toLowerCase() === 'receita') ? v : -v;
                labels.push(new Date(r.data).toLocaleDateString());
                valores.push(saldo);
            });

            new Chart(document.getElementById('graficoLinhas'), {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'Saldo acumulado',
                        data: valores,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40,167,69,0.2)',
                        fill: true
                    }]
                }
            });

            // --- Área: evolução receitas vs despesas ---
            const datas = [];
            const receitas = [];
            const despesas = [];
            ordenados.forEach(r => {
                datas.push(new Date(r.data).toLocaleDateString());
                if ((r.tipo || '').toLowerCase() === 'receita') {
                    receitas.push(Number(r.valor || 0));
                    despesas.push(0);
                } else {
                    despesas.push(Number(r.valor || 0));
                    receitas.push(0);
                }
            });

            new Chart(document.getElementById('graficoArea'), {
                type: 'line',
                data: {
                    labels: datas,
                    datasets: [
                        { label: 'Receitas', data: receitas, borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.3)', fill: true },
                        { label: 'Despesas', data: despesas, borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.3)', fill: true }
                    ]
                }
            });
        }

        carregarFinanceiro();
    </script>
}
