@{
    ViewData["Title"] = "Dashboard Financeiro";
}

<h2 class="mb-4">Dashboard Financeiro</h2>

<!-- CARDS -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-success text-white text-center">
            <div class="card-body">
                <h6>Entradas</h6>
                <h4 id="totalEntrada">R$ 0,00</h4>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-danger text-white text-center">
            <div class="card-body">
                <h6>Saídas</h6>
                <h4 id="totalSaida">R$ 0,00</h4>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card bg-dark text-white text-center">
            <div class="card-body">
                <h6>Saldo</h6>
                <h4 id="saldoTotal">R$ 0,00</h4>
            </div>
        </div>
    </div>
</div>

<!-- GRÁFICOS -->
<div class="row">
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                Entrada x Saída
            </div>
            <div class="card-body" style="height:260px">
                <canvas id="graficoDonut"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                Evolução Financeira
            </div>
            <div class="card-body" style="height:260px">
                <canvas id="graficoBarras"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let dados = [];
        let donutChart, barChart;

        /* =====================
           CARREGAMENTO
        ===================== */
        async function carregarFinanceiro() {
            const resp = await fetch('/Financeiro/Listar');
            dados = await resp.json();

            if (!Array.isArray(dados) || dados.length === 0) {
                alert("Sem dados financeiros");
                return;
            }

            atualizarTudo();
        }

        /* =====================
           ATUALIZA GERAL
        ===================== */
        function atualizarTudo() {
            atualizarCards(dados);
            atualizarDonut(dados);
            atualizarBarras(dados);
        }

        /* =====================
           CARDS
        ===================== */
        function atualizarCards(registros) {
            let entrada = 0, saida = 0;

            registros.forEach(r => {
                const valor = Number(r.valor || 0);
                const tipo = (r.tipo || '').toLowerCase();

                if (tipo.includes('receita') || tipo.includes('entrada'))
                    entrada += valor;
                else
                    saida += valor;
            });

            totalEntrada.innerText =
                entrada.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            totalSaida.innerText =
                saida.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            saldoTotal.innerText =
                (entrada - saida).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        /* =====================
           DONUT ENTRADA x SAÍDA
        ===================== */
        function atualizarDonut(registros) {
            let entrada = 0, saida = 0;

            registros.forEach(r => {
                const valor = Number(r.valor || 0);
                const tipo = (r.tipo || '').toLowerCase();

                if (tipo.includes('receita') || tipo.includes('entrada'))
                    entrada += valor;
                else
                    saida += valor;
            });

            if (donutChart) donutChart.destroy();

            donutChart = new Chart(graficoDonut, {
                type: 'doughnut',
                data: {
                    labels: ['Entradas', 'Saídas'],
                    datasets: [{
                        data: [entrada, saida],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }

        /* =====================
           BARRAS - EVOLUÇÃO
        ===================== */
        function atualizarBarras(registros) {
            const grupos = {};

            registros.forEach(r => {
                const d = new Date(r.data);
                if (isNaN(d)) return;

                const chave = d.toLocaleDateString('pt-BR', {
                    month: 'short',
                    year: 'numeric'
                });

                grupos[chave] ??= { entrada: 0, saida: 0 };

                const valor = Number(r.valor || 0);
                const tipo = (r.tipo || '').toLowerCase();

                if (tipo.includes('receita') || tipo.includes('entrada'))
                    grupos[chave].entrada += valor;
                else
                    grupos[chave].saida += valor;
            });

            if (barChart) barChart.destroy();

            barChart = new Chart(graficoBarras, {
                type: 'bar',
                data: {
                    labels: Object.keys(grupos),
                    datasets: [
                        {
                            label: 'Entradas',
                            data: Object.values(grupos).map(g => g.entrada),
                            backgroundColor: '#28a745',
                            barThickness: 14
                        },
                        {
                            label: 'Saídas',
                            data: Object.values(grupos).map(g => g.saida),
                            backgroundColor: '#dc3545',
                            barThickness: 14
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }

        carregarFinanceiro();
    </script>
}
