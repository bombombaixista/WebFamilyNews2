@{
    ViewData["Title"] = "Gerenciar Backup";
}

<div class="container mt-4">

    <!-- HEADER -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body text-white" style="background: linear-gradient(135deg,#0d6efd,#6f42c1);">
            <h3 class="mb-1">💾 Backup do Sistema</h3>
            <small>Mantenha seus dados seguros com exportação, importação e relatórios PDF</small>
        </div>
    </div>

    <!-- CARD PRINCIPAL -->
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-9 col-12">

            <div class="card shadow-lg border-0">
                <div class="card-body text-center p-4">

                    <p class="text-muted mb-4 fs-5">
                        Escolha abaixo a operação desejada para proteger seus dados ou gerar relatórios.
                    </p>

                    <!-- BOTÕES BACKUP -->
                    <div class="d-grid gap-3 mb-4">
                        <button type="button" class="btn btn-success btn-lg fw-bold" onclick="exportarTudo()">
                            📤 Exportar Backup Completo
                        </button>

                        <button type="button" class="btn btn-danger btn-lg fw-bold"
                                onclick="document.getElementById('arquivoZipTotal').click()">
                            📥 Importar Tudo (sobrescrever)
                        </button>
                        <input type="file" id="arquivoZipTotal" accept=".zip" hidden onchange="importarTudo(event)" />

                        <button type="button" class="btn btn-primary btn-lg fw-bold"
                                onclick="document.getElementById('arquivoJson').click()">
                            📥 Importar Arquivo
                        </button>
                        <input type="file" id="arquivoJson" accept=".json" hidden onchange="importarArquivo(event)" />
                    </div>

                    <!-- EXPORTAR ARQUIVO ESPECÍFICO -->
                    <div class="text-start mt-4">
                        <label for="selectArquivo" class="form-label fw-bold">📂 Escolher arquivo para exportar</label>
                        <div class="input-group">
                            <select id="selectArquivo" class="form-select">
                                <option value="">Selecione um arquivo...</option>
                            </select>
                            <button type="button"
                                    class="btn btn-outline-info fw-bold"
                                    onclick="exportarSelecionado()">
                                Exportar
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Os arquivos listados são da pasta <code>Data</code>.
                            <br />Os backups exportados já vêm com <strong>data/hora no nome</strong> para facilitar a organização.
                        </small>
                    </div>

                    <!-- BOTÕES PDF -->
                    <div class="d-flex flex-wrap gap-2 mt-4 mb-3 justify-content-center">
                        <a asp-controller="Relatorio"
                           asp-action="Financeiro"
                           target="_blank"
                           class="btn btn-danger">
                            📄 PDF Financeiro
                        </a>

                        <a asp-controller="RelatorioProdutoEstoque"
                           asp-action="Executivo"
                           target="_blank"
                           class="btn btn-success">
                            📦 PDF Produto / Estoque
                        </a>
                    </div>

                    <!-- ALERTA -->
                    <div class="alert alert-warning mt-4 text-start">
                        <h6 class="fw-bold">⚠ Atenção:</h6>
                        <ul class="mb-0 ps-3">
                            <li>Importar um backup total substituirá todos os dados existentes.</li>
                            <li>Importar um arquivo mescla com os dados existentes.</li>
                            <li>Relatórios PDF não alteram dados.</li>
                            <li><strong>Os backups exportados já vêm com data/hora no nome</strong>, facilitando a organização dos arquivos.</li>
                        </ul>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>

<!-- TOASTS -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body d-flex align-items-center gap-2" id="toastMessage">
                <!-- Ícone + Mensagem -->
            </div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', carregarArquivos);

        function showToast(message, type = "success") {
            const toastEl = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');

            // Definir ícone e cor
            let icon = "";
            let bgClass = "";
            switch (type) {
                case "success":
                    icon = "✅";
                    bgClass = "text-bg-success";
                    break;
                case "error":
                    icon = "❌";
                    bgClass = "text-bg-danger";
                    break;
                case "info":
                    icon = "ℹ️";
                    bgClass = "text-bg-primary";
                    break;
            }

            toastMessage.innerHTML = `${icon} ${message}`;
            toastEl.className = `toast align-items-center border-0 ${bgClass}`;

            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }

        function exportarTudo() {
            window.location.href = '/Backup/ExportarTudo';
            showToast("Backup completo exportado com sucesso!", "success");
        }

        async function importarTudo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("arquivo", file);

            const resp = await fetch('/Backup/ImportarTudo', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                showToast("Backup total importado com sucesso!", "success");
                location.reload();
            } else {
                showToast("Erro ao importar backup total.", "error");
            }
        }

        async function importarArquivo(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("arquivo", file);

            const resp = await fetch('/Backup/ImportarArquivo', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                showToast("Arquivo importado com sucesso!", "success");
                location.reload();
            } else {
                showToast("Erro ao importar arquivo.", "error");
            }
        }

        async function carregarArquivos() {
            const resp = await fetch('/Backup/ListarArquivos');
            if (!resp.ok) return;

            const arquivos = await resp.json();
            const select = document.getElementById('selectArquivo');

            select.innerHTML = '<option value="">Selecione um arquivo...</option>';

            arquivos.forEach(nome => {
                const opt = document.createElement('option');
                opt.value = nome;
                opt.textContent = nome;
                select.appendChild(opt);
            });
        }

        function exportarSelecionado() {
            const nome = document.getElementById('selectArquivo').value;
            if (!nome) {
                showToast("Selecione um arquivo para exportar.", "info");
                return;
            }

            window.location.href =
                '/Backup/ExportarArquivo?nomeArquivo=' + encodeURIComponent(nome);
            showToast("Arquivo exportado com sucesso!", "success");
        }
    </script>
}
