@{
    ViewData["Title"] = "Financeiro";
}

<style>
    /* ===== DESTAQUE DA BARRA DE FILTRO ===== */
    .filtro-destaque {
        background: #f1f8f5;
        border-left: 6px solid #198754;
    }

        .filtro-destaque .form-label {
            font-weight: 600;
            color: #0f5132;
        }

        .filtro-destaque .btn-success {
            box-shadow: 0 4px 12px rgba(25, 135, 84, 0.45);
        }

    .grafico-mini {
        max-width: 150px;
        max-height: 120px;
        margin: auto;
    }
</style>

<!-- DASHBOARD -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#198754">
            <div class="card-body">
                <div class="small">Saldo</div>
                <h4 id="dashSaldo">R$ 0,00</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#0d6efd">
            <div class="card-body">
                <div class="small">Entradas</div>
                <h4 id="dashEntradas">R$ 0,00</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#dc3545">
            <div class="card-body">
                <div class="small">Saídas</div>
                <h4 id="dashSaidas">R$ 0,00</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card shadow-sm">
            <div class="card-body">
                <div class="small">Movimentações</div>
                <h4 id="dashQtd">0</h4>
            </div>
        </div>
    </div>
</div>

<!-- GRÁFICOS MINI -->
<div class="row text-center mb-4 g-3">
    <div class="col-md-4">
        <div class="grafico-mini">
            <canvas id="graficoDonutTipo"></canvas>
        </div>
        <small>Entrada x Saída</small>
    </div>
    <div class="col-md-4">
        <div class="grafico-mini">
            <canvas id="graficoBarraCategoria"></canvas>
        </div>
        <small>Por Categoria</small>
    </div>
    <div class="col-md-4">
        <div class="grafico-mini">
            <canvas id="graficoLinhaSaldo"></canvas>
        </div>
        <small>Tendência Saldo</small>
    </div>
</div>

<!-- FILTROS -->
<div class="card shadow-sm mb-3 filtro-destaque">
    <div class="card-body row g-2 align-items-end">
        <div class="col-md-2">
            <label class="form-label">Tipo</label>
            <select id="filtroTipo" class="form-select">
                <option value="">Todos</option>
                <option value="Entrada">Entrada</option>
                <option value="Saida">Saída</option>
            </select>
        </div>

        <div class="col-md-2">
            <label class="form-label">Período</label>
            <select id="filtroPeriodo" class="form-select">
                <option value="">Manual</option>
                <option value="hoje">Hoje</option>
                <option value="mes">Mês</option>
                <option value="ano">Ano</option>
            </select>
        </div>

        <div class="col-md-3">
            <label class="form-label">Início</label>
            <input type="date" id="filtroInicio" class="form-control">
        </div>

        <div class="col-md-3">
            <label class="form-label">Fim</label>
            <input type="date" id="filtroFim" class="form-control">
        </div>

        <div class="col-md-2 d-flex gap-2">
            <button class="btn btn-success w-100" onclick="aplicarFiltros()">Filtrar</button>
            <button class="btn btn-secondary w-100" onclick="limparFiltros()">Limpar</button>
        </div>
    </div>
</div>

<!-- AÇÕES: NOVA MOVIMENTAÇÃO / EXPORTAR / IMPORTAR CSV -->
<div class="mb-3 d-flex gap-2 justify-content-end">
    <button class="btn btn-primary" onclick="abrirModalNovo()">➕ Nova Movimentação</button>
    <button class="btn btn-outline-primary" onclick="exportarCSV()">📄 Exportar CSV</button>
    <input type="file" id="importCSVInput" accept=".csv" style="display:none" onchange="importarCSV(event)">
    <button class="btn btn-outline-secondary" onclick="document.getElementById('importCSVInput').click()">📥 Importar CSV</button>
</div>

<!-- TABELA -->
<div class="card shadow-sm">
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Descrição</th>
                    <th>Tipo</th>
                    <th>Valor</th>
                    <th>Categoria</th>
                    <th>Data</th>
                    <th class="text-center">Ações</th>
                </tr>
            </thead>
            <tbody id="financeiro"></tbody>
        </table>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalFinanceiro">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 id="modalTitulo">Movimentação</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <input type="hidden" id="movId">

                <div class="col-md-6">
                    <label class="form-label">Descrição</label>
                    <input id="descricao" class="form-control">
                </div>

                <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select id="tipo" class="form-select">
                        <option value="Entrada">Entrada</option>
                        <option value="Saida">Saída</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Valor</label>
                    <input type="number" step="0.01" id="valor" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Categoria</label>
                    <input id="categoria" class="form-control">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Data</label>
                    <input type="date" id="data" class="form-control">
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="salvarMovimentacao()">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let modal;
        let cache = [];
        let listaAtual = [];
        let chartDonutTipo, chartBarraCategoria, chartLinhaSaldo;

        document.addEventListener("DOMContentLoaded", () => {
            modal = new bootstrap.Modal(document.getElementById("modalFinanceiro"));
            carregarFinanceiro();
        });

        function somenteData(str) {
            return str.split('T')[0];
        }

        async function carregarFinanceiro() {
            const r = await fetch('/Financeiro/Listar');
            cache = await r.json();
            listaAtual = [...cache];
            atualizarDashboard(listaAtual);
            renderTabela(listaAtual);
            atualizarGraficos(listaAtual);
        }

        function atualizarDashboard(lista) {
            let ent = 0, sai = 0;
            lista.forEach(m => {
                const v = Number(m.valor || 0);
                m.tipo === "Entrada" ? ent += v : sai += v;
            });

            dashEntradas.innerText = ent.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            dashSaidas.innerText   = sai.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            dashSaldo.innerText   = (ent - sai).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
            dashQtd.innerText     = lista.length;
        }

        function aplicarFiltros() {
            const tipo = filtroTipo.value;
            const ini = filtroInicio.value;
            const fim = filtroFim.value;

            listaAtual = cache.filter(m => {
                const d = somenteData(m.data);
                if (tipo && m.tipo !== tipo) return false;
                if (ini && d < ini) return false;
                if (fim && d > fim) return false;
                return true;
            });

            atualizarDashboard(listaAtual);
            renderTabela(listaAtual);
            atualizarGraficos(listaAtual);
        }

        filtroPeriodo.addEventListener("change", () => {
            const hoje = new Date().toISOString().slice(0,10);

            if (filtroPeriodo.value === "hoje") {
                filtroInicio.value = hoje;
                filtroFim.value = hoje;
            }

            if (filtroPeriodo.value === "mes") {
                const d = new Date();
                filtroInicio.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
                filtroFim.value = hoje;
            }

            if (filtroPeriodo.value === "ano") {
                const y = new Date().getFullYear();
                filtroInicio.value = `${y}-01-01`;
                filtroFim.value = hoje;
            }

            aplicarFiltros();
        });

        function limparFiltros() {
            filtroTipo.value = filtroPeriodo.value = filtroInicio.value = filtroFim.value = "";
            listaAtual = [...cache];
            atualizarDashboard(listaAtual);
            renderTabela(listaAtual);
            atualizarGraficos(listaAtual);
        }

        function renderTabela(lista) {
            financeiro.innerHTML = "";
            lista.forEach(m => {
                financeiro.innerHTML += `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.descricao}</td>
                    <td><span class="badge ${m.tipo==='Entrada'?'bg-success':'bg-danger'}">${m.tipo}</span></td>
                    <td class="${m.tipo==='Entrada'?'text-success':'text-danger'}">
                        ${Number(m.valor||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}
                    </td>
                    <td>${m.categoria}</td>
                    <td>${new Date(m.data).toLocaleDateString()}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning text-white" onclick="abrirModalEditar(${m.id})">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="apagarMovimentacao(${m.id})">🗑️</button>
                    </td>
                </tr>`;
            });
        }

        function abrirModalNovo() {
            movId.value = "";
            descricao.value = categoria.value = "";
            valor.value = 0;
            data.value = "";
            modal.show();
        }

        function abrirModalEditar(id) {
            const m = cache.find(x => x.id === id);
            movId.value = m.id;
            descricao.value = m.descricao;
            tipo.value = m.tipo;
            valor.value = m.valor;
            categoria.value = m.categoria;
            data.value = somenteData(m.data);
            modal.show();
        }

        async function salvarMovimentacao() {
            const id = movId.value;
            const mov = {
                descricao: descricao.value,
                tipo: tipo.value,
                valor: Number(valor.value),
                categoria: categoria.value,
                data: data.value
            };

            await fetch(id ? `/Financeiro/Editar/${id}` : `/Financeiro/Adicionar`, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(mov)
            });

            modal.hide();
            carregarFinanceiro();
        }

        async function apagarMovimentacao(id) {
            if (!confirm("Excluir movimentação?")) return;
            await fetch(`/Financeiro/Apagar/${id}`, { method: 'DELETE' });
            carregarFinanceiro();
        }

        // ===== CSV =====
        function exportarCSV() {
            if (!listaAtual.length) return alert("Não há movimentações para exportar.");
            const csvHeader = ["ID","Descrição","Tipo","Valor","Categoria","Data"];
            const csvRows = listaAtual.map(m => [
                m.id,
                `"${(m.descricao||"").replace(/"/g,'""')}"`,
                m.tipo,
                m.valor,
                `"${(m.categoria||"").replace(/"/g,'""')}"`,
                m.data
            ].join(","));
            const csvContent = [csvHeader.join(","), ...csvRows].join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `financeiro_export_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importarCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async e => {
                const text = e.target.result;
                const linhas = text.split(/\r?\n/).slice(1);
                for (let linha of linhas) {
                    if (!linha.trim()) continue;
                    const [id, descricao, tipoMov, valor, categoria, dataMov] = linha.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g,"").trim());
                    await fetch(id ? `/Financeiro/Editar/${id}` : `/Financeiro/Adicionar`, {
                        method: id ? 'PUT' : 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            descricao,
                            tipo: tipoMov,
                            valor: Number(valor),
                            categoria,
                            data: dataMov
                        })
                    });
                }
                carregarFinanceiro();
                alert("Importação concluída!");
            };
            reader.readAsText(file);
        }

        // ===== GRÁFICOS =====
        function atualizarGraficos(lista) {
            // Destroi gráficos antigos
            if(chartDonutTipo) chartDonutTipo.destroy();
            if(chartBarraCategoria) chartBarraCategoria.destroy();
            if(chartLinhaSaldo) chartLinhaSaldo.destroy();

            // ===== DONUT ENTRADA X SAÍDA =====
            const ent = lista.filter(m => m.tipo==='Entrada').length;
            const sai = lista.filter(m => m.tipo==='Saida').length;
            chartDonutTipo = new Chart(document.getElementById('graficoDonutTipo'), {
                type: 'doughnut',
                data: {
                    labels: ['Entrada','Saída'],
                    datasets:[{
                        data:[ent,sai],
                        backgroundColor:['#198754','#dc3545']
                    }]
                },
                options: { cutout:'60%', plugins:{tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}`}}}, maintainAspectRatio:false }
            });

            // ===== BARRAS POR CATEGORIA =====
            const categorias = [...new Set(lista.map(m=>m.categoria).filter(c=>c))];
            const qtdCategorias = categorias.map(c=>lista.filter(m=>m.categoria===c).length);
            const cores = categorias.map((_,i)=>`hsl(${i*60 % 360}, 70%, 50%)`);
            chartBarraCategoria = new Chart(document.getElementById('graficoBarraCategoria'), {
                type:'bar',
                data:{ labels:categorias, datasets:[{ data:qtdCategorias, backgroundColor:cores }]},
                options:{ plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>`${ctx.label}: ${ctx.raw}`}}}, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
            });

            // ===== LINHA TENDÊNCIA SALDO =====
            const listaOrdenada = [...lista].sort((a,b)=>new Date(a.data)-new Date(b.data));
            let saldo = 0;
            const datas = [], saldos = [];
            listaOrdenada.forEach(m=>{
                saldo += m.tipo==='Entrada'? Number(m.valor) : -Number(m.valor);
                datas.push(somenteData(m.data));
                saldos.push(saldo);
            });
            chartLinhaSaldo = new Chart(document.getElementById('graficoLinhaSaldo'),{
                type:'line',
                data:{ labels:datas, datasets:[{ label:'Saldo', data:saldos, borderColor:'#0d6efd', backgroundColor:'rgba(13,110,253,0.2)', tension:0.3 }]},
                options:{ plugins:{legend:{display:false}, tooltip:{callbacks:{label:ctx=>`R$ ${ctx.raw.toLocaleString('pt-BR',{minimumFractionDigits:2})}`}}}, maintainAspectRatio:false, scales:{y:{beginAtZero:false}}}
            });
        }
    </script>
}
