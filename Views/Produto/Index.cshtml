@{
    ViewData["Title"] = "Gestão de Produtos";
}

<!-- DASHBOARD -->
<div class="row g-3 mb-4">
    <div class="col-6 col-md-3">
        <div class="card shadow-sm border-0 text-white"
             style="background: linear-gradient(135deg,#6f42c1,#59339d);">
            <div class="card-body">
                <div class="small">Produtos</div>
                <h4 id="dashTotal">0</h4>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card shadow-sm border-0 text-white"
             style="background: linear-gradient(135deg,#e83e8c,#c2185b);">
            <div class="card-body">
                <div class="small">Categorias</div>
                <h4 id="dashCategorias">0</h4>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card shadow-sm border-0 text-white"
             style="background: linear-gradient(135deg,#fd7e14,#e8590c);">
            <div class="card-body">
                <div class="small">Fornecedores</div>
                <h4 id="dashFornecedores">0</h4>
            </div>
        </div>
    </div>

    <div class="col-6 col-md-3">
        <div class="card shadow-sm border-0 text-white"
             style="background: linear-gradient(135deg,#20c997,#198754);">
            <div class="card-body">
                <div class="small">Estoque Total</div>
                <h4 id="dashEstoque">0</h4>
            </div>
        </div>
    </div>
</div>

<!-- HEADER -->
<div class="card shadow-sm mb-3 border-0">
    <div class="card-body d-flex justify-content-between align-items-center flex-wrap"
         style="background: linear-gradient(135deg,#6f42c1,#e83e8c); color:white;">
        <h5 class="mb-2 mb-md-0">📦 Gestão de Produtos</h5>

        <button class="btn btn-light fw-bold text-purple"
                onclick="abrirModalNovo()">
            ➕ Novo Produto
        </button>
    </div>
</div>

<!-- TABELA -->
<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead style="background:#faf5ff;">
                    <tr class="text-secondary">
                        <th>#</th>
                        <th>Nome</th>
                        <th class="d-none d-md-table-cell">Categoria</th>
                        <th>Preço</th>
                        <th class="d-none d-md-table-cell">Fornecedor</th>
                        <th>Estoque</th>
                        <th class="text-center">Ações</th>
                    </tr>
                </thead>
                <tbody id="produtos"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalProduto" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header"
                 style="background: linear-gradient(135deg,#e83e8c,#6f42c1); color:white;">
                <h5 class="modal-title" id="modalTitulo">Produto</h5>
                <button class="btn-close btn-close-white"
                        data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <input type="hidden" id="produtoId">

                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label">Nome</label>
                        <input type="text" id="nome" class="form-control">
                    </div>

                    <div class="col-12 col-md-6">
                        <label class="form-label">Categoria</label>
                        <input type="text" id="categoria" class="form-control">
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label">Preço</label>
                        <input type="number" step="0.01" id="preco" class="form-control">
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label">Fornecedor</label>
                        <input type="text" id="fornecedor" class="form-control">
                    </div>

                    <div class="col-12 col-md-4">
                        <label class="form-label">Estoque</label>
                        <input type="number" id="estoque" class="form-control">
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-outline-secondary"
                        data-bs-dismiss="modal">
                    Cancelar
                </button>

                <button class="btn btn-success"
                        onclick="salvarProduto()">
                    💾 Salvar
                </button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .form-control:focus {
            border-color: #e83e8c;
            box-shadow: 0 0 0 .15rem rgba(232,62,140,.25);
        }
    </style>
}

@section Scripts {
    <script>
        let modal;
        let cacheProdutos = [];

        document.addEventListener("DOMContentLoaded", () => {
            modal = new bootstrap.Modal(document.getElementById("modalProduto"));
            carregarProdutos();
        });

        async function carregarProdutos() {
            const resp = await fetch('/Produto/Listar');
            cacheProdutos = await resp.json();

            atualizarDashboard();
            renderTabela();
        }

        function atualizarDashboard() {
            dashTotal.innerText = cacheProdutos.length;
            dashCategorias.innerText = new Set(cacheProdutos.map(p => p.categoria)).size;
            dashFornecedores.innerText = new Set(cacheProdutos.map(p => p.fornecedor)).size;
            dashEstoque.innerText = cacheProdutos.reduce((s, p) => s + p.estoque, 0);
        }

        function badgeEstoque(v) {
            if (v <= 0) return `<span class="badge bg-danger">Sem</span>`;
            if (v <= 5) return `<span class="badge bg-warning text-dark">Baixo</span>`;
            return `<span class="badge bg-success">OK</span>`;
        }

        function renderTabela() {
            produtos.innerHTML = "";
            cacheProdutos.forEach(p => {
                produtos.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nome}</td>
                    <td class="d-none d-md-table-cell">${p.categoria}</td>
                    <td>R$ ${p.preco.toFixed(2)}</td>
                    <td class="d-none d-md-table-cell">${p.fornecedor}</td>
                    <td>${badgeEstoque(p.estoque)} <small>(${p.estoque})</small></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning text-white me-1"
                                onclick="abrirModalEditar(${p.id})">✏️</button>
                        <button class="btn btn-sm btn-danger"
                                onclick="apagarProduto(${p.id})">🗑️</button>
                    </td>
                </tr>`;
            });
        }

        function abrirModalNovo() {
            modalTitulo.innerText = "Novo Produto";
            produtoId.value = "";
            limparFormulario();
            modal.show();
        }

        function abrirModalEditar(id) {
            const p = cacheProdutos.find(x => x.id === id);
            produtoId.value = p.id;
            nome.value = p.nome;
            categoria.value = p.categoria;
            preco.value = p.preco;
            fornecedor.value = p.fornecedor;
            estoque.value = p.estoque;

            modalTitulo.innerText = "Editar Produto";
            modal.show();
        }

        async function salvarProduto() {
            const id = produtoId.value;

            const produto = {
                nome: nome.value,
                categoria: categoria.value,
                preco: Number(preco.value),
                fornecedor: fornecedor.value,
                estoque: Number(estoque.value)
            };

            await fetch(id ? `/Produto/Editar/${id}` : `/Produto/Adicionar`, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(produto)
            });

            modal.hide();
            carregarProdutos();
        }

        async function apagarProduto(id) {
            if (!confirm("Excluir produto?")) return;
            await fetch(`/Produto/Apagar/${id}`, { method: 'DELETE' });
            carregarProdutos();
        }

        function limparFormulario() {
            nome.value = categoria.value = preco.value = fornecedor.value = estoque.value = "";
        }
    </script>
}
