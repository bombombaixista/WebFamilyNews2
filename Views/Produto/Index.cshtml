@model List<Kanban.Models.Produto>

<div class="container mt-4">
    <h2 class="mb-4 text-center">📊 Dashboard de Estoque</h2>

    <!-- Cards de resumo -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-white bg-primary shadow">
                <div class="card-body">
                    <h5>Total de Produtos</h5>
                    <h3>@Model.Count</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success shadow">
                <div class="card-body">
                    <h5>Estoque Total</h5>
                    <h3>@Model.Sum(p => p.Estoque)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning shadow">
                <div class="card-body">
                    <h5>Valor em Estoque</h5>
                    <h3>R$ @Model.Sum(p => p.Estoque * p.Preco)</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger shadow">
                <div class="card-body">
                    <h5>Produtos Críticos</h5>
                    <h3>@Model.Count(p => p.Estoque < 5)</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos -->
    <div class="row mb-4 text-center">
        <div class="col-md-4">
            <div style="height:200px; width:200px; margin:auto;">
                <canvas id="graficoPizza"></canvas>
            </div>
            <small>Produtos por Categoria</small>
        </div>
        <div class="col-md-4">
            <div style="height:200px; width:200px; margin:auto;">
                <canvas id="graficoDonut"></canvas>
            </div>
            <small>Estoque Disponível</small>
        </div>
        <div class="col-md-4">
            <div style="height:200px; width:200px; margin:auto;">
                <canvas id="graficoBarra"></canvas>
            </div>
            <small>Quantidade por Produto</small>
        </div>
    </div>

    <!-- Filtros avançados -->
    <div class="card shadow-sm mb-3 filtro-destaque">
        <div class="card-body row g-2 align-items-end">
            <div class="col-md-3">
                <label class="form-label">Buscar por Nome</label>
                <input id="filtroNome" class="form-control" placeholder="Digite o nome do produto">
            </div>
            <div class="col-md-2">
                <label class="form-label">Categoria</label>
                <select id="filtroCategoria" class="form-select">
                    <option value="">Todas</option>
                    @foreach (var cat in Model.Select(p => p.Categoria).Distinct())
                    {
                        <option>@cat</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Fornecedor</label>
                <select id="filtroFornecedor" class="form-select">
                    <option value="">Todos</option>
                    @foreach (var forn in Model.Select(p => p.Fornecedor).Distinct())
                    {
                        <option>@forn</option>
                    }
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">Preço Máx.</label>
                <input id="filtroPreco" type="number" class="form-control" placeholder="Ex: 100">
            </div>
            <div class="col-md-2">
                <label class="form-label">Estoque Mín.</label>
                <input id="filtroEstoque" type="number" class="form-control" placeholder="Ex: 10">
            </div>
            <div class="col-md-1 d-grid gap-1">
                <button class="btn btn-success" onclick="aplicarFiltros()">Filtrar</button>
                <button class="btn btn-secondary" onclick="limparFiltros()">Limpar</button>
            </div>
        </div>
    </div>

    <!-- Tabela de produtos -->
    <div class="card shadow">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">📦 Lista de Produtos</h5>
        </div>
        <div class="card-body">
            <table class="table table-hover table-bordered align-middle">
                <thead class="table-secondary">
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Categoria</th>
                        <th>Fornecedor</th>
                        <th>Marca</th>
                        <th>Tamanho</th>
                        <th>Cor</th>
                        <th>Material</th>
                        <th>Estoque</th>
                        <th>Preço</th>
                        <th>Ações</th>
                    </tr>
                </thead>
                <tbody id="produtosTabela">
                    @foreach (var p in Model)
                    {
                        var estoqueClass = p.Estoque < 5 ? "table-danger" : "table-light";
                        <tr class="@estoqueClass">
                            <td>@p.Id</td>
                            <td>@p.Nome</td>
                            <td>@p.Categoria</td>
                            <td>@p.Fornecedor</td>
                            <td>@p.Marca</td>
                            <td>@p.Tamanho</td>
                            <td>@p.Cor</td>
                            <td>@p.Material</td>
                            <td>@p.Estoque</td>
                            <td>R$ @p.Preco</td>
                            <td>
                                <a asp-action="Edit" asp-route-id="@p.Id" class="btn btn-warning btn-sm">✏️ Editar</a>
                                <button class="btn btn-primary btn-sm ms-1" onclick="abrirModal(@p.Id, 'Entrada')">Entrada</button>
                                <button class="btn btn-danger btn-sm ms-1" onclick="abrirModal(@p.Id, 'Saida')">Saída</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal de Movimentação -->
<div class="modal fade" id="movModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="movModalTitulo">Movimentação</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="movForm" method="post">
                <div class="modal-body">
                    <input type="hidden" name="id" id="movId">
                    <div class="mb-2">
                        <label>Quantidade</label>
                        <input type="number" name="quantidade" id="movQuantidade" class="form-control" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Confirmar</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .filtro-destaque { background: #f1f8f5; border-left: 6px solid #198754; }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const modalMov = new bootstrap.Modal(document.getElementById("movModal"));

        function abrirModal(id, tipo) {
            document.getElementById("movId").value = id;
            document.getElementById("movForm").action = "/Produto/" + tipo;
            document.getElementById("movModalTitulo").innerText = tipo;
            document.getElementById("movQuantidade").value = 1;
            modalMov.show();
        }

        // === Filtros avançados ===
        function aplicarFiltros() {
            const nome = document.getElementById("filtroNome").value.toLowerCase();
            const categoria = document.getElementById("filtroCategoria").value;
            const fornecedor = document.getElementById("filtroFornecedor").value;
            const precoMax = parseFloat(document.getElementById("filtroPreco").value);
            const estoqueMin = parseInt(document.getElementById("filtroEstoque").value);

            document.querySelectorAll("#produtosTabela tr").forEach(tr => {
                const td = tr.querySelectorAll("td");
                const nomeProd = td[1].innerText.toLowerCase();
                const categoriaProd = td[2].innerText;
                const fornecedorProd = td[3].innerText;
                const estoqueProd = parseInt(td[8].innerText);
                const precoProd = parseFloat(td[9].innerText.replace("R$", "").replace(",", ".").trim());

                let visivel = true;
                if (nome && !nomeProd.includes(nome)) visivel = false;
                if (categoria && categoriaProd !== categoria) visivel = false;
                if (fornecedor && fornecedorProd !== fornecedor) visivel = false;
                if (!isNaN(precoMax) && precoProd > precoMax) visivel = false;
                if (!isNaN(estoqueMin) && estoqueProd < estoqueMin) visivel = false;

                tr.style.display = visivel ? "" : "none";
            });
        }

        function limparFiltros() {
            document.getElementById("filtroNome").value = "";
            document.getElementById("filtroCategoria").value = "";
            document.getElementById("filtroFornecedor").value = "";
            document.getElementById("filtroPreco").value = "";
            document.getElementById("filtroEstoque").value = "";
            aplicarFiltros();
        }

        document.addEventListener("DOMContentLoaded", function () {
            // === Gráfico Pizza ===
            const categorias = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(p => p.Categoria)));
            const countsCat = {};
            categorias.forEach(c => countsCat[c] = (countsCat[c] || 0) + 1);

            new Chart(document.getElementById('graficoPizza'), {
                type: 'pie',
                data: { labels: Object.keys(countsCat), datasets: [{ data: Object.values(countsCat), backgroundColor: ['#007bff','#28a745','#ffc107','#17a2b8','#dc3545'] }] },
                options: { responsive:true, maintainAspectRatio:false }
            });

            // === Gráfico Donut ===
            const estoques = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(p => p.Estoque)));
            const nomes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Select(p => p.Nome)));

            new Chart(document.getElementById('graficoDonut'), {
                type: 'doughnut',
                data: { labels: nomes, datasets: [{ data: estoques, backgroundColor: ['#0d6efd','#198754','#ffc107','#fd7e14','#6f42c1'] }] },
                options: { cutout: '60%', responsive:true, maintainAspectRatio:false }
            });

            // === Gráfico Barras ===
            new Chart(document.getElementById('graficoBarra'), {
                type: 'bar',
                data: { labels: nomes, datasets:[{ label:'Estoque', data:estoques, backgroundColor:'#17a2b8' }] },
                options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
            });
        });
    </script>
}
