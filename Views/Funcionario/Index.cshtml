@{
    ViewData["Title"] = "Dashboard de Funcionários";
}

<h2 class="text-center mb-4">👥 Dashboard de Funcionários</h2>

<div class="text-center mb-3">
    <a href="/Funcionario/Cadastrar" class="btn btn-primary">
        ➕ Cadastrar Novo Funcionário
    </a>
</div>

<!-- KPIs -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white text-center shadow-sm">
            <div class="card-body py-3">
                <small>Total Funcionários</small>
                <h4 id="totalFuncionarios">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white text-center shadow-sm">
            <div class="card-body py-3">
                <small>Média Salarial</small>
                <h4 id="mediaSalarial">R$ 0,00</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark text-center shadow-sm">
            <div class="card-body py-3">
                <small>Departamentos</small>
                <h4 id="totalDepartamentos">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white text-center shadow-sm">
            <div class="card-body py-3">
                <small>Última Admissão</small>
                <h4 id="ultimaAdmissao">-</h4>
            </div>
        </div>
    </div>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4">
    <div class="card-body row g-2 align-items-end">
        <div class="col-md-3">
            <label>Nome</label>
            <input id="filtroNome" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label>Departamento</label>
            <input id="filtroDepartamento" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label>Cargo</label>
            <input id="filtroCargo" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label>Salário Min</label>
            <input id="filtroSalarioMin" type="number" class="form-control form-control-sm">
        </div>
        <div class="col-md-2">
            <label>Salário Max</label>
            <input id="filtroSalarioMax" type="number" class="form-control form-control-sm">
        </div>
        <div class="col-md-1 d-grid">
            <button class="btn btn-success btn-sm" onclick="aplicarFiltros()">Filtrar</button>
            <button class="btn btn-secondary btn-sm mt-1" onclick="limparFiltros()">Limpar</button>
        </div>
    </div>
</div>

<!-- GRÁFICOS BEM PEQUENOS -->
<div class="row mb-4 justify-content-center">
    <div class="col-md-4">
        <div class="card shadow-sm text-center p-2">
            <small class="fw-bold">Por Departamento</small>
            <div class="grafico-mini">
                <canvas id="graficoDepartamentos"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm text-center p-2">
            <small class="fw-bold">Admissões</small>
            <div class="grafico-mini">
                <canvas id="graficoAdmissoes"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="alertNenhum" class="alert alert-info" style="display:none;">
    Nenhum funcionário encontrado.
</div>

<!-- TABELA -->
<div class="card shadow">
    <div class="card-body">
        <table class="table table-sm table-hover" id="tabelaFuncionarios">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Admissão</th>
                    <th>Salário</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

@section Styles {
    <style>
        /* GRÁFICOS BEM MENORES */
        .grafico-mini {
            width: 220px;
            height: 160px;
            margin: 10px auto;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let funcionarios = [];
        let graficoDept = null;
        let graficoAdm = null;

        async function carregarFuncionarios() {
            const resp = await fetch('/Funcionario/Listar');
            funcionarios = await resp.json();
            aplicarFiltros();
        }

        function aplicarFiltros() {
            const nome = filtroNome.value.toLowerCase();
            const dep = filtroDepartamento.value.toLowerCase();
            const cargo = filtroCargo.value.toLowerCase();
            const salMin = parseFloat(filtroSalarioMin.value);
            const salMax = parseFloat(filtroSalarioMax.value);

            const lista = funcionarios.filter(f => {
                if (nome && !f.nome.toLowerCase().includes(nome)) return false;
                if (dep && !f.departamento.toLowerCase().includes(dep)) return false;
                if (cargo && !f.cargo.toLowerCase().includes(cargo)) return false;
                if (!isNaN(salMin) && f.salario < salMin) return false;
                if (!isNaN(salMax) && f.salario > salMax) return false;
                return true;
            });

            atualizarTela(lista);
            atualizarGraficos(lista);
        }

        function limparFiltros() {
            document.querySelectorAll("input").forEach(i => i.value = "");
            atualizarTela(funcionarios);
            atualizarGraficos(funcionarios);
        }

        function atualizarTela(lista) {
            const tbody = document.querySelector("#tabelaFuncionarios tbody");
            tbody.innerHTML = "";

            if (!lista.length) {
                alertNenhum.style.display = "block";
                return;
            }
            alertNenhum.style.display = "none";

            totalFuncionarios.innerText = lista.length;
            mediaSalarial.innerText =
                (lista.reduce((a,f)=>a+f.salario,0)/lista.length)
                .toLocaleString('pt-BR',{style:'currency',currency:'BRL'});

            totalDepartamentos.innerText = [...new Set(lista.map(f=>f.departamento))].length;

            ultimaAdmissao.innerText =
                new Date(lista.reduce((a,b)=> new Date(a.dataAdmissao) > new Date(b.dataAdmissao) ? a : b).dataAdmissao)
                .toLocaleDateString();

            lista.forEach(f => {
                tbody.innerHTML += `
                <tr>
                    <td>${f.id}</td>
                    <td>${f.nome}</td>
                    <td>${f.cargo}</td>
                    <td>${f.departamento}</td>
                    <td>${new Date(f.dataAdmissao).toLocaleDateString()}</td>
                    <td>${f.salario.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})}</td>
                    <td>
                        <a href="/Funcionario/Editar/${f.id}" class="btn btn-sm btn-warning">✏️</a>
                        <button class="btn btn-sm btn-danger" onclick="apagar(${f.id})">🗑</button>
                    </td>
                </tr>`;
            });
        }

        function atualizarGraficos(lista) {
            if (graficoDept) graficoDept.destroy();
            if (graficoAdm) graficoAdm.destroy();

            const deps = [...new Set(lista.map(f => f.departamento))];
            graficoDept = new Chart(graficoDepartamentos, {
                type: 'pie',
                data: {
                    labels: deps,
                    datasets: [{
                        data: deps.map(d => lista.filter(f => f.departamento === d).length),
                        backgroundColor: ['#0d6efd','#198754','#ffc107','#0dcaf0','#dc3545']
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });

            const meses = {};
            lista.forEach(f => {
                const m = new Date(f.dataAdmissao)
                    .toLocaleString('pt-BR',{month:'short',year:'numeric'});
                meses[m] = (meses[m]||0)+1;
            });

            graficoAdm = new Chart(graficoAdmissoes, {
                type: 'bar',
                data: {
                    labels: Object.keys(meses),
                    datasets: [{
                        data: Object.values(meses),
                        backgroundColor:'#0dcaf0'
                    }]
                },
                options: { responsive:true, maintainAspectRatio:false }
            });
        }

        async function apagar(id) {
            if (!confirm("Excluir funcionário?")) return;
            await fetch(`/Funcionario/Apagar/${id}`, { method:'DELETE' });
            carregarFuncionarios();
        }

        document.addEventListener('DOMContentLoaded', carregarFuncionarios);
    </script>
}
