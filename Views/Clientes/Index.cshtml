@{
    ViewData["Title"] = "Clientes";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- DASHBOARD -->
<div class="row g-3 mb-4">
    <div class="col-md-3"><div class="card text-white" style="background:#0d6efd"><div class="card-body"><small>Clientes</small><h4 id="dashTotal">0</h4></div></div></div>
    <div class="col-md-3"><div class="card text-white" style="background:#198754"><div class="card-body"><small>Empresas</small><h4 id="dashEmpresas">0</h4></div></div></div>
    <div class="col-md-3"><div class="card text-white" style="background:#6f42c1"><div class="card-body"><small>Origens</small><h4 id="dashOrigens">0</h4></div></div></div>
    <div class="col-md-3"><div class="card text-white" style="background:#fd7e14"><div class="card-body"><small>Cad. no Mês</small><h4 id="dashMes">0</h4></div></div></div>
</div>

<!-- GRÁFICOS -->
<div class="row text-center mb-4">
    <div class="col-md-4"><div class="grafico-box"><canvas id="graficoPizza"></canvas></div><small>Por Empresa</small></div>
    <div class="col-md-4"><div class="grafico-box"><canvas id="graficoDonut"></canvas></div><small>Origem</small></div>
    <div class="col-md-4"><div class="grafico-box"><canvas id="graficoBarra"></canvas></div><small>Cadastros</small></div>
</div>

<!-- FILTROS -->
<div class="card mb-3 shadow-sm">
    <div class="card-body row g-2">
        <div class="col-md-4">
            <input id="filtroNome" class="form-control" placeholder="Filtrar por nome">
        </div>
        <div class="col-md-4">
            <input id="filtroEmpresa" class="form-control" placeholder="Filtrar por empresa">
        </div>
        <div class="col-md-4 d-flex gap-2">
            <button class="btn btn-primary w-100" onclick="aplicarFiltro()">Filtrar</button>
            <button class="btn btn-secondary w-100" onclick="limparFiltro()">Limpar</button>
        </div>
    </div>
</div>

<!-- AÇÕES -->
<div class="d-flex justify-content-between mb-2">
    <h5>Lista de Clientes</h5>
    <button class="btn btn-success" onclick="novoCliente()">➕ Novo Cliente</button>
</div>

<!-- TABELA -->
<div class="card shadow-sm">
    <table class="table table-hover mb-0">
        <thead class="table-dark">
            <tr>
                <th>Nome</th>
                <th>Email</th>
                <th>Empresa</th>
                <th>Origem</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody id="clientesTable"></tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalCliente">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form id="clienteForm" class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitulo">Cliente</h5>
                <button class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="clienteId">
                <div class="row g-2">
                    <div class="col-md-6"><input id="nome" class="form-control" placeholder="Nome" required></div>
                    <div class="col-md-6"><input id="email" class="form-control" placeholder="Email"></div>
                    <div class="col-md-4"><input id="empresa" class="form-control" placeholder="Empresa"></div>
                    <div class="col-md-4"><input id="telefone" class="form-control" placeholder="Telefone"></div>
                    <div class="col-md-4">
                        <select id="origem" class="form-select">
                            <option>Site</option>
                            <option>WhatsApp</option>
                            <option>Indicação</option>
                            <option>Outro</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success">Salvar</button>
            </div>
        </form>
    </div>
</div>

@section Styles {
    <style>
        .grafico-box {
            max-width: 160px;
            height: 140px;
            margin: auto;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let lista=[], modal;
        let chartPizza, chartDonut, chartBarra;

        document.addEventListener("DOMContentLoaded",()=>{
            modal = new bootstrap.Modal(modalCliente);
            carregarClientes();
        });

        async function carregarClientes(){
            const r = await fetch('/Clientes/Listar');
            lista = await r.json();
            atualizarTudo(lista);
        }

        function aplicarFiltro(){
            const nome=filtroNome.value.toLowerCase();
            const emp=filtroEmpresa.value.toLowerCase();
            const filtrados = lista.filter(c =>
                (!nome || c.nome.toLowerCase().includes(nome)) &&
                (!emp || (c.empresa||"").toLowerCase().includes(emp))
            );
            atualizarTudo(filtrados);
        }

        function limparFiltro(){
            filtroNome.value="";
            filtroEmpresa.value="";
            atualizarTudo(lista);
        }

        function atualizarTudo(d){
            dashTotal.innerText=d.length;
            dashEmpresas.innerText=[...new Set(d.map(c=>c.empresa).filter(x=>x))].length;
            dashOrigens.innerText=[...new Set(d.map(c=>c.origem))].length;
            dashMes.innerText=d.length;
            renderTabela(d);
            atualizarGraficos(d);
        }

        function renderTabela(d){
            clientesTable.innerHTML="";
            d.forEach(c=>{
                clientesTable.innerHTML+=`
                <tr>
                    <td>${c.nome}</td>
                    <td>${c.email||"-"}</td>
                    <td>${c.empresa||"-"}</td>
                    <td>${c.origem}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning" onclick="editar(${c.id})">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="excluir(${c.id})">🗑️</button>
                    </td>
                </tr>`;
            });
        }

        function atualizarGraficos(d){
            chartPizza?.destroy(); chartDonut?.destroy(); chartBarra?.destroy();
            const emp=[...new Set(d.map(c=>c.empresa).filter(x=>x))];
            const qtd=emp.map(e=>d.filter(c=>c.empresa===e).length);
            chartPizza=new Chart(graficoPizza,{type:'pie',data:{labels:emp,datasets:[{data:qtd}]},options:{maintainAspectRatio:false}});
            chartDonut=new Chart(graficoDonut,{type:'doughnut',data:{labels:emp,datasets:[{data:qtd}]},options:{cutout:'65%',maintainAspectRatio:false}});
            chartBarra=new Chart(graficoBarra,{type:'bar',data:{labels:emp,datasets:[{data:qtd}]},options:{plugins:{legend:{display:false}},maintainAspectRatio:false}});
        }

        function novoCliente(){
            clienteId.value="";
            clienteForm.reset();
            modalTitulo.innerText="Novo Cliente";
            modal.show();
        }

        function editar(id){
            const c=lista.find(x=>x.id===id);
            if(!c)return;
            clienteId.value=c.id;
            nome.value=c.nome;
            email.value=c.email;
            empresa.value=c.empresa;
            telefone.value=c.telefone;
            origem.value=c.origem;
            modalTitulo.innerText="Editar Cliente";
            modal.show();
        }

        async function excluir(id){
            if(!confirm("Excluir cliente?"))return;
            await fetch(`/Clientes/Apagar/${id}`,{method:'DELETE'});
            carregarClientes();
        }

        clienteForm.addEventListener("submit",async e=>{
            e.preventDefault();
            const id=clienteId.value;
            await fetch(id?`/Clientes/Editar/${id}`:'/Clientes/Adicionar',{
                method:id?'PUT':'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({nome:nome.value,email:email.value,empresa:empresa.value,telefone:telefone.value,origem:origem.value})
            });
            modal.hide();
            carregarClientes();
        });
    </script>
}
