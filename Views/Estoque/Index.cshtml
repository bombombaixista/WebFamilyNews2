<div class="mb-3 text-center">
    <a asp-action="Create" class="btn btn-success me-2">➕ Adicionar Produto</a>
    <a asp-action="Movimentacoes" class="btn btn-info me-2">📜 Histórico</a>

    <!-- CSV -->
    <button class="btn btn-outline-primary me-2" onclick="exportarCSV()">📄 Exportar CSV</button>
    <input type="file" id="importCSVInput" accept=".csv" style="display:none" onchange="importarCSV(event)">
    <button class="btn btn-outline-secondary" onclick="document.getElementById('importCSVInput').click()">📥 Importar CSV</button>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Dados iniciais
        let produtos = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));

        let graficoCategorias;
        let graficoEstoque;

        document.addEventListener("DOMContentLoaded", function () {
            renderizarGraficos();
            renderTabela(produtos);
        });

        // ===== RENDERIZAÇÃO DE TABELA =====
        function renderTabela(lista) {
            const tbody = document.getElementById("produtosTabela");
            tbody.innerHTML = "";

            lista.forEach(p => {
                const estoqueClass = p.Estoque < 5 ? "table-danger" : "table-light";
                const tr = document.createElement("tr");
                tr.className = estoqueClass;
                tr.innerHTML = `
                    <td>${p.Id}</td>
                    <td>${p.Nome}</td>
                    <td>${p.Categoria}</td>
                    <td>${p.Fornecedor}</td>
                    <td>${p.Marca}</td>
                    <td>${p.Tamanho}</td>
                    <td>${p.Cor}</td>
                    <td>${p.Material}</td>
                    <td>${p.Estoque}</td>
                    <td>R$ ${p.Preco}</td>
                    <td>
                        <a href="/Produto/Edit/${p.Id}" class="btn btn-warning btn-sm">✏️ Editar</a>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ===== RENDERIZAÇÃO DE GRÁFICOS =====
        function renderizarGraficos() {
            // Gráfico por categoria
            const categorias = produtos.map(p => p.Categoria);
            const countsCat = {};
            categorias.forEach(c => countsCat[c] = (countsCat[c] || 0) + 1);

            const ctxCat = document.getElementById('graficoCategorias').getContext('2d');
            if (graficoCategorias) graficoCategorias.destroy();
            graficoCategorias = new Chart(ctxCat, {
                type: 'pie',
                data: {
                    labels: Object.keys(countsCat),
                    datasets: [{
                        data: Object.values(countsCat),
                        backgroundColor: ['#007bff','#28a745','#ffc107','#17a2b8','#dc3545']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Gráfico de estoque
            const nomes = produtos.map(p => p.Nome);
            const estoques = produtos.map(p => p.Estoque);

            const ctxEst = document.getElementById('graficoEstoque').getContext('2d');
            if (graficoEstoque) graficoEstoque.destroy();
            graficoEstoque = new Chart(ctxEst, {
                type: 'bar',
                data: {
                    labels: nomes,
                    datasets: [{
                        label: 'Estoque',
                        data: estoques,
                        backgroundColor: '#17a2b8'
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        // ===== FILTROS =====
        function aplicarFiltros() {
            const nome = document.getElementById("filtroNome").value.toLowerCase();
            const categoria = document.getElementById("filtroCategoria").value;
            const fornecedor = document.getElementById("filtroFornecedor").value;
            const precoMax = parseFloat(document.getElementById("filtroPreco").value);
            const estoqueMin = parseInt(document.getElementById("filtroEstoque").value);

            const listaFiltrada = produtos.filter(p => {
                if (nome && !p.Nome.toLowerCase().includes(nome)) return false;
                if (categoria && p.Categoria !== categoria) return false;
                if (fornecedor && p.Fornecedor !== fornecedor) return false;
                if (!isNaN(precoMax) && p.Preco > precoMax) return false;
                if (!isNaN(estoqueMin) && p.Estoque < estoqueMin) return false;
                return true;
            });

            renderTabela(listaFiltrada);
            renderizarGraficos();
        }

        function limparFiltros() {
            document.getElementById("filtroNome").value = "";
            document.getElementById("filtroCategoria").value = "";
            document.getElementById("filtroFornecedor").value = "";
            document.getElementById("filtroPreco").value = "";
            document.getElementById("filtroEstoque").value = "";
            renderTabela(produtos);
            renderizarGraficos();
        }

        // ===== EXPORTAR CSV =====
        function exportarCSV() {
            if (!produtos.length) return alert("Não há produtos para exportar.");

            const linhas = [["ID","Nome","Categoria","Fornecedor","Marca","Tamanho","Cor","Material","Estoque","Preco"]];
            produtos.forEach(p => {
                linhas.push([
                    p.Id,
                    `"${p.Nome.replace(/"/g,'""')}"`,
                    `"${p.Categoria.replace(/"/g,'""')}"`,
                    `"${p.Fornecedor.replace(/"/g,'""')}"`,
                    `"${p.Marca.replace(/"/g,'""')}"`,
                    `"${p.Tamanho.replace(/"/g,'""')}"`,
                    `"${p.Cor.replace(/"/g,'""')}"`,
                    `"${p.Material.replace(/"/g,'""')}"`,
                    p.Estoque,
                    p.Preco
                ]);
            });

            const csvContent = linhas.map(l => l.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);

            const link = document.createElement("a");
            link.href = url;
            link.download = `estoque_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // ===== IMPORTAR CSV =====
        function importarCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => {
                const text = e.target.result;
                const linhas = text.split(/\r?\n/).slice(1); // ignora cabeçalho

                linhas.forEach(linha => {
                    if (!linha.trim()) return;

                    const cols = linha.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.replace(/^"|"$/g,"").trim());
                    const produto = {
                        Id: Number(cols[0]),
                        Nome: cols[1],
                        Categoria: cols[2],
                        Fornecedor: cols[3],
                        Marca: cols[4],
                        Tamanho: cols[5],
                        Cor: cols[6],
                        Material: cols[7],
                        Estoque: Number(cols[8]),
                        Preco: Number(cols[9])
                    };

                    // Atualiza se já existe, senão adiciona
                    const index = produtos.findIndex(p => p.Id === produto.Id);
                    if (index >= 0) {
                        produtos[index] = produto;
                    } else {
                        produtos.push(produto);
                    }
                });

                renderTabela(produtos);
                renderizarGraficos();
                alert("Importação concluída e tabela atualizada!");
            };
            reader.readAsText(file);
        }
    </script>
}
