@{
    ViewData["Title"] = "Gestão de Fornecedores";
}

<h2 class="mb-4">🏭 Gestão de Fornecedores</h2>

<!-- DASHBOARD -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#4e73df">
            <div class="card-body text-center">
                <div class="small">Fornecedores</div>
                <h4 id="dashTotal">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#1cc88a">
            <div class="card-body text-center">
                <div class="small">Empresas</div>
                <h4 id="dashEmpresas">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#36b9cc">
            <div class="card-body text-center">
                <div class="small">Produtos</div>
                <h4 id="dashProdutos">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white shadow-sm" style="background:#f6c23e">
            <div class="card-body text-center">
                <div class="small">Ativos</div>
                <h4>100%</h4>
            </div>
        </div>
    </div>
</div>

<!-- GRÁFICOS -->
<div class="row mb-4 text-center">
    <div class="col-md-4">
        <div class="card shadow-sm p-2">
            <small class="fw-bold">Por Empresa</small>
            <div class="grafico-box">
                <canvas id="graficoEmpresa"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm p-2">
            <small class="fw-bold">Por Produto</small>
            <div class="grafico-box">
                <canvas id="graficoProduto"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow-sm p-2">
            <small class="fw-bold">Distribuição</small>
            <div class="grafico-box">
                <canvas id="graficoBarra"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- FILTROS -->
<div class="card shadow-sm mb-3 filtro-destaque">
    <div class="card-body row g-2 align-items-end">
        <div class="col-md-4">
            <label>Buscar</label>
            <input id="filtroBusca" class="form-control" placeholder="Nome, empresa, produto">
        </div>
        <div class="col-md-3">
            <label>Empresa</label>
            <select id="filtroEmpresa" class="form-select"></select>
        </div>
        <div class="col-md-3">
            <label>Produto</label>
            <select id="filtroProduto" class="form-select"></select>
        </div>
        <div class="col-md-2 d-grid">
            <button class="btn btn-success" onclick="aplicarFiltros()">Filtrar</button>
            <button class="btn btn-secondary mt-1" onclick="limparFiltros()">Limpar</button>
        </div>
    </div>
</div>

<!-- AÇÃO -->
<div class="mb-3 text-end">
    <button class="btn btn-primary" onclick="abrirModalNovo()">➕ Novo Fornecedor</button>
</div>

<!-- TABELA -->
<div class="card shadow-sm">
    <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
            <tr>
                <th>#</th>
                <th>Nome</th>
                <th>Empresa</th>
                <th>Telefone</th>
                <th>Email</th>
                <th>Produto</th>
                <th class="text-center">Ações</th>
            </tr>
        </thead>
        <tbody id="fornecedores"></tbody>
    </table>
</div>

<!-- MODAL -->
<div class="modal fade" id="modalFornecedor">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5>Fornecedor</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body row g-3">
                <input type="hidden" id="fornecedorId">
                <div class="col-md-6">
                    <label>Nome</label>
                    <input id="nome" class="form-control">
                </div>
                <div class="col-md-6">
                    <label>Empresa</label>
                    <input id="empresa" class="form-control">
                </div>
                <div class="col-md-4">
                    <label>Telefone</label>
                    <input id="telefone" class="form-control">
                </div>
                <div class="col-md-4">
                    <label>Email</label>
                    <input id="email" class="form-control">
                </div>
                <div class="col-md-4">
                    <label>Produto</label>
                    <input id="produto" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button class="btn btn-success" onclick="salvarFornecedor()">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .grafico-box {
            width: 200px;
            height: 160px;
            margin: auto;
        }

        canvas {
            width: 100% !important;
            height: 100% !important;
        }

        .filtro-destaque {
            background: #f1f8f5;
            border-left: 6px solid #198754;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let modal;
        let cache = [];
        let lista = [];
        let gEmpresa, gProduto, gBarra;

        document.addEventListener("DOMContentLoaded", async () => {
            modal = new bootstrap.Modal(modalFornecedor);
            await carregarFornecedores();
        });

        async function carregarFornecedores() {
            const r = await fetch('/Fornecedor/Listar');
            cache = await r.json();
            lista = [...cache];
            popularSelects();
            atualizarDashboard();
            renderTabela();
            atualizarGraficos();
        }

        function popularSelects() {
            filtroEmpresa.innerHTML = `<option value="">Todas</option>` +
                [...new Set(cache.map(f => f.empresa))].map(e => `<option>${e}</option>`).join("");
            filtroProduto.innerHTML = `<option value="">Todos</option>` +
                [...new Set(cache.map(f => f.produto))].map(p => `<option>${p}</option>`).join("");
        }

        function atualizarDashboard() {
            dashTotal.innerText = lista.length;
            dashEmpresas.innerText = new Set(lista.map(f => f.empresa)).size;
            dashProdutos.innerText = new Set(lista.map(f => f.produto)).size;
        }

        function renderTabela() {
            fornecedores.innerHTML = "";
            lista.forEach(f => {
                fornecedores.innerHTML += `
                <tr>
                    <td>${f.id}</td>
                    <td>${f.nome}</td>
                    <td>${f.empresa}</td>
                    <td>${f.telefone || "-"}</td>
                    <td>${f.email || "-"}</td>
                    <td><span class="badge bg-info">${f.produto}</span></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-warning text-white" onclick="abrirModalEditar(${f.id})">✏️</button>
                        <button class="btn btn-sm btn-danger" onclick="apagarFornecedor(${f.id})">🗑️</button>
                    </td>
                </tr>`;
            });
        }

        function atualizarGraficos() {
            if (gEmpresa) gEmpresa.destroy();
            if (gProduto) gProduto.destroy();
            if (gBarra) gBarra.destroy();

            const empresas = [...new Set(lista.map(f => f.empresa))];
            const prod = [...new Set(lista.map(f => f.produto))];

            gEmpresa = new Chart(graficoEmpresa, {
                type:'pie',
                data:{ labels:empresas, datasets:[{ data:empresas.map(e=>lista.filter(f=>f.empresa===e).length) }] },
                options:{ maintainAspectRatio:false }
            });

            gProduto = new Chart(graficoProduto, {
                type:'doughnut',
                data:{ labels:prod, datasets:[{ data:prod.map(p=>lista.filter(f=>f.produto===p).length) }] },
                options:{ maintainAspectRatio:false }
            });

            gBarra = new Chart(graficoBarra, {
                type:'bar',
                data:{ labels:empresas, datasets:[{ data:empresas.map(e=>lista.filter(f=>f.empresa===e).length) }] },
                options:{ maintainAspectRatio:false }
            });
        }

        function aplicarFiltros() {
            const b = filtroBusca.value.toLowerCase();
            lista = cache.filter(f =>
                `${f.nome} ${f.empresa} ${f.produto}`.toLowerCase().includes(b) &&
                (!filtroEmpresa.value || f.empresa === filtroEmpresa.value) &&
                (!filtroProduto.value || f.produto === filtroProduto.value)
            );
            atualizarDashboard();
            renderTabela();
            atualizarGraficos();
        }

        function limparFiltros() {
            filtroBusca.value = filtroEmpresa.value = filtroProduto.value = "";
            lista = [...cache];
            atualizarDashboard();
            renderTabela();
            atualizarGraficos();
        }

        function abrirModalNovo() {
            fornecedorId.value = "";
            nome.value = empresa.value = telefone.value = email.value = produto.value = "";
            modal.show();
        }

        function abrirModalEditar(id) {
            const f = cache.find(x => x.id === id);
            fornecedorId.value = f.id;
            nome.value = f.nome;
            empresa.value = f.empresa;
            telefone.value = f.telefone;
            email.value = f.email;
            produto.value = f.produto;
            modal.show();
        }

        async function salvarFornecedor() {
            const id = fornecedorId.value;
            await fetch(id ? `/Fornecedor/Editar/${id}` : `/Fornecedor/Adicionar`, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    nome:nome.value, empresa:empresa.value,
                    telefone:telefone.value, email:email.value, produto:produto.value
                })
            });
            modal.hide();
            carregarFornecedores();
        }

        async function apagarFornecedor(id) {
            if (!confirm("Excluir fornecedor?")) return;
            await fetch(`/Fornecedor/Apagar/${id}`, { method:'DELETE' });
            carregarFornecedores();
        }
    </script>
}
