@{
    ViewData["Title"] = "Agenda";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="text-center mb-4 bg-primary text-white p-3 rounded shadow">
    📅 Agenda
</h2>

<!-- DASHBOARD -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card text-white" style="background:#0d6efd">
            <div class="card-body"><small>Total</small><h4 id="dashTotal">0</h4></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background:#198754">
            <div class="card-body"><small>Hoje</small><h4 id="dashHoje">0</h4></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background:#6f42c1">
            <div class="card-body"><small>Reuniões</small><h4 id="dashReunioes">0</h4></div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white" style="background:#fd7e14">
            <div class="card-body"><small>Compromissos</small><h4 id="dashCompromissos">0</h4></div>
        </div>
    </div>
</div>

<!-- GRÁFICOS -->
<div class="row text-center mb-4">
    <div class="col-md-4">
        <div class="grafico-box"><canvas id="graficoPizza"></canvas></div>
        <small>Por Categoria</small>
    </div>
    <div class="col-md-4">
        <div class="grafico-box"><canvas id="graficoDonut"></canvas></div>
        <small>Eventos Hoje</small>
    </div>
    <div class="col-md-4">
        <div class="grafico-box"><canvas id="graficoBarra"></canvas></div>
        <small>Resumo</small>
    </div>
</div>

<!-- FILTROS -->
<div class="card mb-3 shadow-sm">
    <div class="card-body row g-2">
        <div class="col-md-4">
            <input id="filtroBusca" class="form-control" placeholder="Filtrar por título ou descrição">
        </div>
        <div class="col-md-4">
            <select id="filtroCategoria" class="form-select">
                <option value="">Todas</option>
                <option>Reunião</option>
                <option>Compromisso</option>
                <option>Pessoal</option>
                <option>Tarefa</option>
                <option>Projeto</option>
                <option>Outros</option>
            </select>
        </div>
        <div class="col-md-4 d-flex gap-2">
            <button class="btn btn-primary w-100" onclick="aplicarFiltros()">Filtrar</button>
            <button class="btn btn-secondary w-100" onclick="limparFiltros()">Limpar</button>
        </div>
    </div>
</div>

<!-- BOTÕES NOVO / EXPORTAR / IMPORTAR CSV -->
<div class="mb-3 d-flex gap-2 justify-content-end">
    <button class="btn btn-success" onclick="novoEvento()">➕ Novo Evento</button>
    <button class="btn btn-outline-primary" onclick="exportarCSV()">📄 Exportar CSV</button>
    <input type="file" id="importCSVInput" accept=".csv" style="display:none" onchange="importarCSV(event)">
    <button class="btn btn-outline-secondary" onclick="document.getElementById('importCSVInput').click()">📥 Importar CSV</button>
</div>

<!-- BOTÕES DE VISUALIZAÇÃO -->
<div class="mb-3 d-flex gap-2 justify-content-start">
    <button class="btn btn-outline-primary" onclick="calendar.changeView('dayGridMonth')">Mês</button>
    <button class="btn btn-outline-primary" onclick="calendar.changeView('timeGridWeek')">Semana</button>
    <button class="btn btn-outline-primary" onclick="calendar.changeView('timeGridDay')">Dia</button>
</div>

<div id="calendar"></div>

<!-- MODAL -->
<div class="modal fade" id="eventModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="modalTitulo">Evento</h5>
                <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="id">
                <div class="mb-2"><input id="titulo" class="form-control" placeholder="Título"></div>
                <div class="mb-2">
                    <select id="categoria" class="form-select">
                        <option>Reunião</option>
                        <option>Compromisso</option>
                        <option>Pessoal</option>
                        <option>Tarefa</option>
                        <option>Projeto</option>
                        <option>Outros</option>
                    </select>
                </div>
                <div class="mb-2"><textarea id="descricao" class="form-control" placeholder="Descrição"></textarea></div>
                <div class="mb-2"><input type="datetime-local" id="inicio" class="form-control"></div>
                <div class="mb-2"><input type="datetime-local" id="fim" class="form-control"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="excluirEvento()">Excluir</button>
                <button class="btn btn-success" onclick="salvarEvento()">Salvar</button>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .grafico-box {
            max-width: 160px;
            height: 140px;
            margin: auto;
        }

        #calendar {
            max-width: 100%;
            margin: auto;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        let eventos = [];
        let calendar, modal;
        let chartPizza, chartDonut, chartBarra;

        const coresCategoria = {
            "Reunião": "#0d6efd",
            "Compromisso": "#198754",
            "Pessoal": "#6f42c1",
            "Tarefa": "#fd7e14",
            "Projeto": "#0dcaf0",
            "Outros": "#ffc107"
        };

        document.addEventListener("DOMContentLoaded", async () => {
            modal = new bootstrap.Modal(document.getElementById("eventModal"));
            await carregarECriarCalendar();
        });

        async function carregarECriarCalendar() {
            eventos = await carregarEventos();

            calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                locale: "pt-br",
                timeZone: "local",
                initialView: "dayGridMonth",
                editable: true,
                eventDurationEditable: true,
                allDaySlot: false,
                events: eventos.map(e => ({ ...e })),
                eventClick: abrirEvento,
                eventDrop: salvarArraste,
                eventResize: salvarArraste,
                eventDidMount: function(info) {
                    const cor = coresCategoria[info.event.extendedProps.categoria] || "#6c757d";
                    info.el.style.backgroundColor = cor;
                    info.el.style.borderColor = cor;
                }
            });

            calendar.render();
            atualizarTudo(eventos);
        }

        async function carregarEventos() {
            const res = await fetch("/Agenda/Listar");
            const lista = await res.json();
            return lista.map(e => ({
                id: e.id,
                title: e.titulo,
                start: e.inicio,
                end: e.fim || undefined,
                extendedProps: { categoria: e.categoria, descricao: e.descricao || "" }
            }));
        }

        function abrirEvento(info) {
            const e = info.event;
            document.getElementById("id").value = e.id;
            document.getElementById("titulo").value = e.title;
            document.getElementById("categoria").value = e.extendedProps.categoria;
            document.getElementById("descricao").value = e.extendedProps.descricao || "";
            document.getElementById("inicio").value = e.startStr.substring(0,16);
            document.getElementById("fim").value = e.endStr ? e.endStr.substring(0,16) : "";
            document.getElementById("modalTitulo").innerText = "Editar Evento";
            modal.show();
        }

        async function salvarEvento() {
            const evento = {
                id: Number(document.getElementById("id").value || 0),
                titulo: document.getElementById("titulo").value,
                categoria: document.getElementById("categoria").value,
                descricao: document.getElementById("descricao").value,
                inicio: document.getElementById("inicio").value,
                fim: document.getElementById("fim").value
            };

            await fetch("/Agenda/Salvar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(evento)
            });

            modal.hide();
            eventos = await carregarEventos();
            calendar.removeAllEvents();
            calendar.addEventSource(eventos);
            atualizarTudo(eventos);
        }

        async function excluirEvento() {
            const id = Number(document.getElementById("id").value);
            if (!id) return;

            await fetch(`/Agenda/Excluir/${id}`, { method: "DELETE" });
            modal.hide();
            eventos = await carregarEventos();
            calendar.removeAllEvents();
            calendar.addEventSource(eventos);
            atualizarTudo(eventos);
        }

        async function salvarArraste(info) {
            const e = info.event;

            await fetch("/Agenda/Salvar", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    id: Number(e.id),
                    titulo: e.title,
                    categoria: e.extendedProps.categoria,
                    descricao: e.extendedProps.descricao || "",
                    inicio: e.startStr.substring(0,16),
                    fim: e.endStr ? e.endStr.substring(0,16) : ""
                })
            });

            eventos = await carregarEventos();
            calendar.removeAllEvents();
            calendar.addEventSource(eventos);
            atualizarTudo(eventos);
        }

        function atualizarTudo(lista) {
            const hoje = new Date();
            document.getElementById("dashTotal").innerText = lista.length;
            document.getElementById("dashHoje").innerText = lista.filter(e => new Date(e.start).toDateString() === hoje.toDateString()).length;
            document.getElementById("dashReunioes").innerText = lista.filter(e => e.extendedProps.categoria === "Reunião").length;
            document.getElementById("dashCompromissos").innerText = lista.filter(e => e.extendedProps.categoria === "Compromisso").length;

            atualizarGraficos(lista);
        }

        function atualizarGraficos(lista) {
            if(chartPizza) chartPizza.destroy();
            if(chartDonut) chartDonut.destroy();
            if(chartBarra) chartBarra.destroy();

            const categorias = Object.keys(coresCategoria);
            const qtdCat = categorias.map(c => lista.filter(e => e.extendedProps.categoria === c).length);

            chartPizza = new Chart(document.getElementById("graficoPizza"), {
                type: "pie",
                data: { labels: categorias, datasets: [{ data: qtdCat, backgroundColor: Object.values(coresCategoria) }] },
                options: { maintainAspectRatio: false }
            });

            const hojeQtd = lista.filter(e => new Date(e.start).toDateString() === new Date().toDateString()).length;
            chartDonut = new Chart(document.getElementById("graficoDonut"), {
                type: "doughnut",
                data: { labels: ["Hoje", "Outros"], datasets: [{ data: [hojeQtd, lista.length - hojeQtd], backgroundColor: ["#198754","#adb5bd"] }] },
                options: { cutout: "65%", maintainAspectRatio: false }
            });

            chartBarra = new Chart(document.getElementById("graficoBarra"), {
                type: "bar",
                data: {
                    labels: ["Total", "Hoje", "Reuniões", "Compromissos"],
                    datasets: [{
                        data: [
                            lista.length,
                            hojeQtd,
                            lista.filter(e => e.extendedProps.categoria === "Reunião").length,
                            lista.filter(e => e.extendedProps.categoria === "Compromisso").length
                        ],
                        backgroundColor: ["#0d6efd","#198754","#6f42c1","#fd7e14"]
                    }]
                },
                options: { plugins: { legend: { display: false } }, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>
}
